<!DOCTYPE html>
<html>
    <body>


        <!--
        -->

        <style type="text/css">
            table  {border-collapse:collapse;border-spacing:0;}
            table td{font-family:Arial, sans-serif;font-size:14px;padding:5px 2px;border-style:solid;border-width:2px;overflow:hidden;word-break:normal;}
            table .cellActive{background-color:#00ff00}
            table .cellNotresponding{background-color:#e6e6e6}
            table .cellHigh{background-color:#ff4d4d}
            table .cellLow{background-color:#b3ccff}
            input.white {background-color:white}
            input.green {background-color:green}
            input.grey {background-color:grey}
            input.red {background-color:red}

            .modal {
                display: none; /* Hidden by default */
                position: fixed; /* Stay in place */
                z-index: 1; /* Sit on top */
                padding-top: 100px; /* Location of the box */
                left: 0;
                top: 0;
                width: 100%; /* Full width */
                height: 100%; /* Full height */
                overflow: auto; /* Enable scroll if needed */
                background-color: rgb(0,0,0); /* Fallback color */
                background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            }
            .modal-content {
                background-color: #fefefe;
                margin: auto;
                padding: 20px;
                border: 1px solid #888;
                width: 80%;
            }
        </style>


        <form>
            RGPIO Server:
            <input type="text" id="serverAddress" name="serverAddress" class="white" value="ws://192.168.0.5:2603">
            <button type="button" id="connectButton">Connect</button>
            <select id="drawingSelector" onchange="loadSelectedDrawing();">
                <option value="none"> Select a drawing </option>
            </select>
            <button type="button" id="propertySelectButton">Properties</button>
            <button type="button" id="deviceSelectButton">Devices</button>
            <button type="button" id="saveDrawingButton">Save Drawing</button>
        </form>
        <br>


        <div id="dropzone"  ondrop="drop(event)" ondragover="allowDrop(event)" style="position:relative;border:1px solid #d3d3d3">

        </div>

        <!-- device selection modal box, hidden by default-->
        <div id="deviceModal" class="modal">
            <div class="modal-content">
                <form id="devicemodalform">
                    <button type="button" id="deviceApply">Apply</button>
                    <button type="button" id="deviceCancel">Cancel</button>
                </form>
            </div>

        </div>
        <!-- property selection modal box, hidden by default-->
        <div id="propertyModal" class="modal">
            <div class="modal-content">
                <form id="propertymodalform">
                    <button type="button" id="propertyApply">Apply</button>
                    <button type="button" id="propertyCancel">Cancel</button>
                </form>
            </div>

        </div>

        <div id="messageDiv" style="overflow-y:scroll; height:400px;border-style:solid;border-width:1px;"></div>

        <script src="https://code.jquery.com/jquery-1.10.2.js"></script>

        <script>


            var g_ws;
            var g_dropzone = document.getElementById("dropzone");
            var g_drawing = "none";
            var g_background = "none";
            var g_allElements = new Object();
            var g_allProperties = new Set();
            var g_hiddenProperties = new Set();
            g_hiddenProperties.add("key");
            g_hiddenProperties.add("visual");

            g_cellColors = {
                "ACTIVE": "cellActive",
                "NOTRESPONDING": "cellNotresponding",
                "High": "cellHigh",
                "Low": "cellLow"
            };

// create the selector in the device selection modal and insert as leftmost element

            g_deviceSelect = document.createElement("select");
            g_deviceSelect.multiple = true;
            devicemodalform = document.getElementById("devicemodalform");
            devicemodalform.insertBefore(g_deviceSelect, devicemodalform.childNodes[0]);
            g_deviceModal = document.getElementById('deviceModal');

// create the selector in the property selection modal and insert as leftmost element

            g_propertySelect = document.createElement("select");
            g_propertySelect.multiple = true;
            propertymodalform = document.getElementById("propertymodalform");
            propertymodalform.insertBefore(g_propertySelect, propertymodalform.childNodes[0]);
            g_propertyModal = document.getElementById('propertyModal');


            function includes(arr, obj) {
                return (arr.indexOf(obj) !== -1);
            }

            function elementIsHidden(element) {
                if (element.visual.style.display == "none")
                    return true;
                else
                    return false;
            }
            function hideElement(element) {
                if ("visual" in element) {
                    element.visual.style.display = "none";
                }
            }
            function unhideElement(element) {
                if ("visual" in element) {
                    element.visual.style.display = "";
                }
            }

            function resetHiddenProperties() {
                g_hiddenProperties.clear();
                g_hiddenProperties.add("key");
                g_hiddenProperties.add("visual");
                g_hiddenProperties.add("left");
                g_hiddenProperties.add("top");
                g_hiddenProperties.add("hidden");
            }


            function applyHiddenProperties() { // hide/unhide all properties according to g_hiddenProperties
                propRows = document.getElementsByClassName("propertyRow");
                for (var i = 0, row; row = propRows[i]; i++) {
                    var keycell = row.children[0];
                    if (g_hiddenProperties.has(keycell.innerHTML)) {
                        row.style.display = "none";
                    } else {
                        row.style.display = "";
                    }
                }
            }



            function loadImage(name, width) {
                var objImage = new Image();
                objImage.onload = function (e) {
                    objImage.width = width;
                    objImage.height = width * (objImage.naturalHeight / objImage.naturalWidth);
                }
                objImage.onerror = function (e) {
                    if (objImage.src.endsWith(".jpg")) {
                        // loading a jpg file failed , trying png
                        objImage.src = objImage.src.replace(".jpg", ".png");
                    } else if (objImage.src.endsWith(".png")) {
                        // loading a png file failed , trying gif
                        objImage.src = objImage.src.replace(".png", ".gif");
                    }

                }
                objImage.src = name + '.jpg';
                return objImage;
            }

            function createObjectPropertyTable(obj) {
                var proptable = document.createElement('table');
                proptable.className = "propertyTable";
                for (var key in obj) {
                    var value = obj[key];
                    //console.log('adding '+key+' ' +obj[key]);
                    var row = document.createElement('tr');
                    row.className = "propertyRow";
                    proptable.appendChild(row);

                    var namecell = document.createElement('td');
                    namecell.style.fontFamily = "Arial, sans-serif";
                    namecell.style.fontSize = "14px";
                    namecell.style.padding = "5px 2px";
                    namecell.style.borderStyle = "none";
                    namecell.innerHTML = key;
                    row.appendChild(namecell);

                    var valuecell = document.createElement('td');
                    valuecell.style.fontFamily = "Arial, sans-serif";
                    valuecell.style.fontSize = "14px";
                    valuecell.style.padding = "5px 2px";
                    valuecell.style.borderStyle = "none";
                    valuecell.innerHTML = value;
                    if (value in g_cellColors)
                        valuecell.setAttribute("class", g_cellColors[value]);
                    row.appendChild(valuecell);

                    // if the property is encountered for the first time, add to g_allProperties and
                    // create an option in the select element

                    if (!g_allProperties.has(key)) {
                        g_allProperties.add(key);

                        var option = document.createElement("option");
                        option.value = key;
                        option.text = key;
                        g_propertySelect.appendChild(option);
                    }
                    if (g_hiddenProperties.has(key)) {
                        row.style.display = "none";
                    }
                }
                return proptable;
            }


            function createObjectVisual(obj) {
                var table = document.createElement('table');
                table.className = "objectVisual";
                table.style.position = "absolute";
                table.style.top = "0px";
                table.style.left = "0px";
                table.style.display = "none"; // not displayed until a drawing is selected

                table.style.backgroundColor = "white";
                var onlyrow = document.createElement('tr');
                table.appendChild(onlyrow);
// cell with image
                var imgcell = document.createElement('td');
                imgcell.style.fontFamily = "Arial, sans-serif";
                imgcell.style.fontSize = "14px";
                imgcell.style.padding = "5px 2px";
                imgcell.style.borderStyle = "none";
                var objImage = loadImage('/RGPIO/html/icons/' + obj.name, 50);
                objImage.draggable = false;
                imgcell.appendChild(objImage);
                onlyrow.appendChild(imgcell);
// cell with properties
                var propcell = document.createElement('td');
                propcell.style.fontFamily = "Arial, sans-serif";
                propcell.style.fontSize = "14px";
                propcell.style.padding = "5px 2px";
                propcell.style.borderStyle = "none";
                var proptable = createObjectPropertyTable(obj);
                propcell.appendChild(proptable);
                onlyrow.appendChild(propcell);

                var objectVisual= table;
                objectVisual.id = obj.key; // must have an id to make it draggable
                g_dropzone.appendChild(objectVisual);
                objectVisual.draggable = true;
                objectVisual.ondragstart = drag;
                objectVisual.style.display = "none"; // not displayed until a drawing is selected
                obj.visual = objectVisual;
 
// apply drawing information if available

                if ("hidden" in obj) {
                 if (!obj.hidden) {
                  objectVisual.style.display = "";
                 }
                }
                if ("top" in obj) presentObject.visual.style.top = obj.top;
                if ("left" in obj) presentObject.visual.style.left = obj.left;

            }

            function visualToObject(visual) {
                // lookup the object's key in the property table
                proptable = visual.getElementsByClassName("propertyTable")[0];
                for (var j = 0, row; row = proptable.rows[j]; j++) {
                    var key;
                    if (row.cells[0].innerHTML === "key") {
                        key = row.cells[1].innerHTML;
                    }
                }
                return g_allElements[key];
            }


            function updateObjectVisual(visual, key, value) {

                proptable = visual.getElementsByClassName("propertyTable")[0];
                for (var i = 0, row; row = proptable.rows[i]; i++) {
                    if (row.cells[0].innerHTML === key) {
                        row.cells[1].innerHTML = value;
                        if (value in g_cellColors)
                            row.cells[1].setAttribute("class", g_cellColors[value]);
                    }
                }
            }

            function findPos(obj) {
                var curleft = curtop = 0;
                if (obj.offsetParent) {
                    do {
                        curleft += obj.offsetLeft;
                        curtop += obj.offsetTop;
                    } while (obj = obj.offsetParent);
                    return [curleft, curtop];
                }
            }

            function allowDrop(ev) {
                ev.preventDefault();
            }

            function drag(ev) {
                /*
                 console.log("drag " + ev.target.id + " clientX,clientY " + ev.clientX + " " + ev.clientY);
                 console.log("drag " + ev.target.id + " target offset from parent " + ev.target.offsetLeft + " " + ev.target.offsetTop);
                 console.log("drag parentElement " + ev.target.parentElement.id);
                 console.log("drag offsetParent " + ev.target.offsetParent.id);
                 */
                // find position of dropzone origin
                var pos = findPos(g_dropzone);
                var parentX = pos[0];
                var parentY = pos[1];
                //console.log("drag parent position " + parentX + " " + parentY);
                // cursor click position on the drag element, relative to the drag element origin
                var relX = ev.clientX - parentX - ev.target.offsetLeft;
                var relY = ev.clientY - parentY - ev.target.offsetTop;
                ev.dataTransfer.setData("objID", ev.target.id);
                ev.dataTransfer.setData("relX", relX);
                ev.dataTransfer.setData("relY", relY);
            }

            function drop(ev) {
                ev.preventDefault();
                var data = ev.dataTransfer.getData("objID");
                var relX = Number(ev.dataTransfer.getData("relX"));
                var relY = Number(ev.dataTransfer.getData("relY"));
                var img = document.getElementById(data);
                // user clicked on (clientX,clientY)
                // calculate position relative to dropzone 
                // and shift the image so that relative mouse position on the element is the same as for drag
                var canvasX = ev.clientX - g_dropzone.offsetLeft - relX;
                var canvasY = ev.clientY - g_dropzone.offsetTop - relY;

                img.style.position = "absolute";
                img.style.top = canvasY + "px";
                img.style.left = canvasX + "px";
            }



            $("#connectButton").click(
                    function () {

                        if ("WebSocket" in window)
                        {
                            var serverAddress = document.getElementById('serverAddress').value;
                            g_ws = new WebSocket(serverAddress);

                            g_ws.onopen = function ()
                            {
                                document.getElementById("messageDiv").innerHTML += "websocket readystate=" + g_ws.readyState + " <br>";
                                document.getElementById("messageDiv").innerHTML += "connected.<br>";
                                document.getElementById("serverAddress").className = "green";
                                var cmd = new Object();
                                cmd.Command = "backgrounds";
                                g_ws.send(JSON.stringify(cmd));
                                var cmd = new Object();
                                cmd.Command = "status";
                                g_ws.send(JSON.stringify(cmd));
                            };

                            g_ws.onclose = function (evt)
                            {
                                document.getElementById("serverAddress").className = "red";
                                document.getElementById("messageDiv").innerHTML += "closed code=" + evt.close + " reason=" + evt.reason + " <br>";
                            };

                            g_ws.onerror = function ()
                            {
                                document.getElementById("serverAddress").className = "red";
                            };

                            g_ws.onmessage = function (event)
                            {
                                if (event.data.length > 0) {
                                    console.log("WS: " + event.data);
                                    try {
                                        var obj = JSON.parse(event.data);
                                    } catch (e) {
                                        document.getElementById("messageDiv").innerHTML += event.data + "<br>";

                                    }
                                    if (typeof obj != "undefined") {

                                        if (obj.object == "BACKGROUNDS") {
                                            // sent in response to 'backgrounds' request. This builds the options list for the drawing select                                            
                                            var drawingSelector = document.getElementById("drawingSelector");
                                            var drawings = obj.list;
                                            for (var i = 0; i < drawings.length; i++) {
                                                var option = document.createElement("option");
                                                option.value = drawings[i];
                                                option.text = drawings[i];
                                                drawingSelector.appendChild(option);
                                            }
                                        }
                                        if (obj.object == "PROPERTY") {
// sent as part of the response to the 'load' request. Lists the properties and if they are hidden
// g_hiddenProperties was reset before so no action needed for visible properties
                                            if (obj.hidden){
                                                g_hiddenProperties.add(obj.name);
                                                applyHiddenProperties();
                                            }
                                        }
                                        if (obj.object == "PDEV") {
                                            obj.key = obj.HWid;
                                        }
                                        if (obj.object == "VDEV") {
                                            obj.key = obj.name;
                                        }
                                        if (obj.object == "VIO") {
                                            obj.key = obj.name;
                                        }
                                        if (obj.object == "PIO") {
                                            obj.key = obj.device + "/" + obj.name;
                                        }

                                        if ("key" in obj) {
                                            if (!(obj.key in g_allElements)) {  // first time this object is sent by the server
                                                document.getElementById("messageDiv").innerHTML += "new element " + obj.key + "<br>";

                                                if ((obj.object == "VDEV") || (obj.object == "PDEV") || (obj.object == "VIO")) {
                                                    // visual is an icon and a table with properties
                                                    var objectVisual = createObjectVisual(obj);

                                                }
                                                if (obj.object == "PIO") {
                                                    // create a property with the name of this PIO in the PDEV it belongs to
                                                    var pdev = g_allElements[obj.device];
                                                    pdev[obj.name] = obj.value;
                                                    // replace the device visual by an updated one
                                                    g_dropzone.removeChild(pdev.visual);
                                                    var pdevVisual = createObjectVisual(pdev);

                                                    // PIO itself has no 'visual' property. It is visualized as an entry in the device property table

                                                }

// Put the object in g_allElements, so that next messages are treated as update

                                                g_allElements[obj.key] = obj;

// Create an option in the  device select element. PIO can not be selected, since its visual is an entry in the property table
// that is controlled by g_hiddenProperties
                                                if ((obj.object == "VDEV") || (obj.object == "PDEV") || (obj.object == "VIO")) {
                                                    var option = document.createElement("option");
                                                    option.value = obj.key;
                                                    option.text = obj.key;
                                                    g_deviceSelect.appendChild(option);
                                                }

                                            } else {   // not the first occurrence of this object =  update 

                                                if ((obj.object == "VDEV") || (obj.object == "PDEV") || (obj.object == "VIO")) {
                                                    var presentObject = g_allElements[obj.key];
                                                    if (("top" in obj) && ("left" in obj)) {
                                                        presentObject.visual.style.left = obj.left;
                                                        presentObject.visual.style.top = obj.top;
                                                        if (obj.hidden) {
                                                            presentObject.visual.style.display = "none";
                                                        } else {
                                                            presentObject.visual.style.display = "";
                                                        }

                                                    } else {
                                                        for (var key in obj) {
                                                            if (presentObject[key] !== obj[key]) {
                                                                presentObject[key] = obj[key];
                                                                if ("visual" in presentObject)
                                                                 updateObjectVisual(presentObject.visual, key, obj[key]);
                                                                else
                                                                 createObjectVisual(presentObject);
                                                            }
                                                        }
                                                    }
                                                }
                                                if (obj.object == "PIO") {
                                                    var presentDevice = g_allElements[obj.device];
                                                    if (presentDevice[obj.name] !== obj.value) {
                                                        presentDevice[obj.name] = obj.value;
                                                    }
                                                    updateObjectVisual(presentDevice.visual, obj.name, obj.value);
                                                }
                                            }
                                        }

                                    }
                                }
                            }


                        } else
                        {

                            alert("WebSocket NOT supported by your Browser!");
                        }
                    }
            );



            document.getElementById("saveDrawingButton").onclick = function () {

                if (g_drawing != "none") {
                    var cmd = new Object();
                    cmd.Command = "store";
                    cmd.Arg1 = g_drawing;
// store top,left,hidden of all elements

                    visuals = g_dropzone.getElementsByClassName("objectVisual");
                    for (var i = 0, visual; visual = visuals[i]; i++) {
                        var obj = visualToObject(visual);
                        //console.log(" visual   object.key=" + obj.key+"   x="+visual.style.left+" y="+visual.style.top);
                        var position = new Object();
                        position.object = obj.object;
                        // store HWid or name so that the element key can be reconstructed from the object
                        if ((obj.object == "VDEV") || (obj.object == "VIO")) {
                            position.name = obj.name;
                        }
                        if (obj.object == "PDEV") {
                            position.HWid = obj.HWid;
                        }
                        position.left = visual.style.left;
                        position.top = visual.style.top;
                        if (visual.style.display == "")
                            position.hidden = false;
                        if (visual.style.display == "none")
                            position.hidden = true;
                        cmd.Arg2 = JSON.stringify(position);
                        g_ws.send(JSON.stringify(cmd));
                        console.log(cmd.Command);
                        console.log(cmd.Arg1);
                        console.log(cmd.Arg2);
                    }

                    // store the properties that are hidden for this drawing                   
                    var hiddenProperties = Array.from(g_hiddenProperties);
                    hiddenProperties.forEach(function (property) {
                        var p = new Object();
                        p.object = "PROPERTY";
                        p.name = property;
                        p.hidden = true;
                        cmd.Arg2 = JSON.stringify(p);
                        g_ws.send(JSON.stringify(cmd));
                        console.log(cmd.Command);
                        console.log(cmd.Arg1);
                        console.log(cmd.Arg2);
                    });

                    cmd.Arg2 = ".";
                    g_ws.send(JSON.stringify(cmd));
                    console.log(cmd.Command);
                    console.log(cmd.Arg1);
                    console.log(cmd.Arg2);

                }
            };

            function loadSelectedDrawing() {
                var drawingSelector = document.getElementById("drawingSelector");
                var options = Array.from(drawingSelector.childNodes);
                options.forEach(function (option) {
                    if (option.selected) {

                        if (option.value !== "none") {
                            g_drawing = option.value;

// display the dropzone background image (replace existing one if any)
                            if (g_background !== "none")
                                dropzone.removeChild(g_background);
                            g_background = loadImage("/RGPIO/html/backgrounds/" + g_drawing, 1600);
                            dropzone.appendChild(g_background);

// hide all elements by default
                            for (var key in g_allElements) {
                                hideElement(g_allElements[key]);
                            }

// unhide all properties by default

                            resetHiddenProperties();
                            applyHiddenProperties();

// ask the server to send the position and hidden status of all the elements
                            var cmd = new Object();
                            cmd.Command = "load";
                            cmd.Arg1 = g_drawing;
                            g_ws.send(JSON.stringify(cmd));
                        }
                    }
                });

            }


// property selection modal 

            document.getElementById("propertySelectButton").onclick = function () {
                // set the hidden properties to 'selected' and open the modal 
                var options = Array.from(g_propertySelect.childNodes);
                console.log(" select options: " + options.length);
                options.forEach(function (option) {
                    if (g_hiddenProperties.has(option.value)) {
                        option.selected = true;
                    } else {
                        option.selected = false;
                    }
                });
                g_propertySelect.size = options.length; // display all properties

                g_propertyModal.style.display = "block";
            }


            // when apply is clicked, the list g_hiddenProps is rebuilt with the selected properties

            var propertyApply = document.getElementById("propertyApply");
            propertyApply.onclick = function () {
                var options = Array.from(g_propertySelect.childNodes);
                resetHiddenProperties();
                options.forEach(function (option) {
                    if (option.selected)
                        g_hiddenProperties.add(option.innerHTML);
                });
                g_propertyModal.style.display = "none";

                // hide the properties in g_hiddenProperties
/*
                propRows = document.getElementsByClassName("propertyRow");
                for (var i = 0, row; row = propRows[i]; i++) {
                    var keycell = row.children[0];
                    if (g_hiddenProperties.has(keycell.innerHTML)) {
                        row.style.display = "none";
                    } else {
                        row.style.display = "";
                    }
                }
*/
                applyHiddenProperties();
            }


            var propertyCancel = document.getElementById("propertyCancel");
            propertyCancel.onclick = function () {
                g_propertyModal.style.display = "none";
            }

// device selection modal 

            // when device select  is clicked, the options of hidden elements are set to selected
            document.getElementById("deviceSelectButton").onclick = function () {
                // set the visible devices to 'selected' and open the modal
                var options = Array.from(g_deviceSelect.childNodes);
                options.forEach(function (option) {
                    if (elementIsHidden(g_allElements[option.value])) {
                        console.log(" present hidden element: " + option.value);
                        option.selected = true;
                    } else {
                        console.log(" present not hidden element: " + option.value);
                        option.selected = false;
                    }
                });
                g_deviceSelect.size = options.length; // display all elements

                g_deviceModal.style.display = "block";
            }

            // when apply is clicked, select elements are hidden

            var deviceApply = document.getElementById("deviceApply");
            deviceApply.onclick = function () {
                var options = Array.from(g_deviceSelect.childNodes);
                options.forEach(function (option) {
                    if (option.selected) {
                        console.log(" hiding element: " + option.value);
                        hideElement(g_allElements[option.value]);
                    } else {
                        console.log(" unhiding element: " + option.value);
                        unhideElement(g_allElements[option.value]);
                    }
                });

                g_deviceModal.style.display = "none";

            }


            var deviceCancel = document.getElementById("deviceCancel");
            deviceCancel.onclick = function () {
                g_deviceModal.style.display = "none";
            }


// When the user clicks anywhere outside of the modal, close it
            window.onclick = function (event) {
                if (event.target == g_propertyModal) {
                    g_propertyModal.style.display = "none";
                }
                if (event.target == g_deviceModal) {
                    g_deviceModal.style.display = "none";
                }
            }

        </script>

    </body>
</html>


