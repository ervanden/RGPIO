<!DOCTYPE html>
<html>
    <body>

        <!--
        
        -->

        <style type="text/css">
            table  {border-collapse:collapse;border-spacing:0;}
            table td{font-family:Arial, sans-serif;font-size:14px;padding:10px 5px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;}
            table th{font-family:Arial, sans-serif;font-size:14px;font-weight:bold;padding:10px 5px;border-style:solid;border-width:1px;overflow:hidden;word-break:normal;}
            table .cellActive{background-color:#ffccc9}
            table .cellNotresponding{background-color:#00ff00}
            table .cellHigh{background-color:#ff4d4d}
            table .cellLow{background-color:#b3ccff}
        </style>

        <div id="tableDiv" ></div>

        <br>
        <table>
            <tr>
                <td id="VDEVhtml">Virtual Devices</td>
                <td id="PDEVhtml">Physical Devices</td>
            </tr>
            <tr>
                <td id="VDIPhtml">Virtual Inputs</td>
                <td id="PDIPhtml">Physical Inputs</td>
            </tr>
            <tr>
                <td id="VDOPhtml">Virtual Outputs</td>
                <td id="PDOPhtml">Physical Outputs</td>
            </tr>
        </table>

        <p>physical device updates</p>

        <div id="messageDiv" style="overflow-y:scroll; height:400px;border-style:solid;border-width:1px;"></div>

        <script src="https://code.jquery.com/jquery-1.10.2.js"></script>

        <script>

            function TableGenerator() {
                this.g_document = null;
                this.g_table = null;
                this.g_columns = null;
                this.g_keys = [];
                this.g_cellColors = {};
                this.g_tableClass = "no name";
                this.g_tableId = "no id";
                this.setDocument = function (obj) {
                    this.g_document = obj;
                };
                this.setCellColors = function (cellColors) {
                    this.g_cellColors = cellColors;
                };
                this.setColumns = function (columns) {
                    this.g_columns = columns;
                };
                this.setKeys = function (keys) {
                    this.g_keys = keys;
                };

                this.createTable = function (id, className) {

                    this.g_tableClass = className;
                    this.g_tableId = id;
                    this.g_cols = {};

                    // create the table and put it in tableDiv
                    this.g_table = this.g_document.createElement('table');
                    this.g_table.id = this.g_tableId;
                    this.g_table.setAttribute("class", this.g_tableClass);

                    // create the table header row
                    var header = this.g_document.createElement('tr');
                    for (var j = 0; j < this.g_columns.length; ++j) {
                        var headerCell = this.g_document.createElement('th');
                        headerCell.innerHTML = this.g_columns[j];
                        header.appendChild(headerCell);
                    }
                    this.g_table.appendChild(header);
                    // create g_cols : assoc array with the index of each column
                    for (var j = 0; j < this.g_table.rows[0].cells.length; j++) {
                        this.g_cols[this.g_table.rows[0].cells[j].innerHTML] = j;
                    }

                    return this.g_table;

                };
                this.addRow = function () { // adds a row to the table and returns the row element
                    var row = this.g_document.createElement('tr');
                    for (var j = 0; j < this.g_columns.length; ++j) {
                        var cell = this.g_document.createElement('td');
                        cell.innerHTML = "new cell";
                        row.appendChild(cell);
                    }
                    this.g_table.appendChild(row);
                    return row;
                };
                this.fillRow = function (obj) {

                    // obj must have properties corresponding to the column names

                    // add a row if there is no row with the keys of 'obj'

                    var matchingRows = this.findRows(obj);
                    console.log(" nr of matching rows=" + matchingRows.length);
                    if (matchingRows.length == 0) {
                        row = this.addRow();
                    } else {
                        row = matchingRows[0];
                    }

                    for (var j = 0; j < this.g_columns.length; ++j) {
                        var content = obj[this.g_columns[j]];
                        row.cells[j].innerHTML = content;
                        if (typeof content != "undefined") {
                            var className = this.g_cellColors[content];
                            if (typeof className != "undefined") {
                                row.cells[j].setAttribute("class", className);
                            }
                        }
                    }
                };
                this.findRows = function (obj) { //find rows that match the properties of this object

                    console.log("findRows()  ");
                    console.log(obj);
                    console.log("g_keys  ");
                    console.log(this.g_keys);
                    console.log("g_cols  ");
                    console.log(this.g_cols);

                    var matchingRows = [];

                    for (var i = 0, row; row = this.g_table.rows[i]; i++) {
                        var match = true;
                        console.log("check row " + row.cells[0].innerHTML);

                        for (var k = 0; k < this.g_keys.length; k++) {
                            var key = this.g_keys[k];     // key name
                            var col = this.g_cols[key];   // key column index
                            console.log("  against key " + key + " in col " + col);
                            if (typeof (col) === "undefined") {
                                console.log("findRows() : key " + key + " not found in table " + this.g_table.id);
                                match = false;
                            } else {
                                console.log("  comparing " + row.cells[col].innerHTML + " to " + obj[key]);
                                if (row.cells[col].innerHTML !== obj[key])
                                    match = false;
                            }

                        }
                        console.log("check row " + row.cells[0].innerHTML + " match=" + match);
                        if (match)
                            matchingRows.push(row);
                    }

                    return matchingRows;

                }
                ;
            }

            var cellColors = {
                "ACTIVE": "cellActive",
                "NOTRESPONDING": "cellNotresponding",
                "High": "cellHigh",
                "Low": "cellLow"
            };

            var PDEVTable = new TableGenerator();
            PDEVTable.setDocument(document);
            PDEVTable.setColumns(["HWid", "model", "ipAddress", "status"]);
            PDEVTable.setKeys(["HWid"]);
            PDEVTable.setCellColors(cellColors);
            var PDEVhtml = PDEVTable.createTable("PDEVTable", "PDEV");

            var VDEVTable = new TableGenerator();
            VDEVTable.setDocument(document);
            VDEVTable.setColumns(["name", "active devices"]);
            VDEVTable.setKeys(["name"]);
            VDEVTable.setCellColors(cellColors);
            var VDEVhtml = VDEVTable.createTable("VDEVTable", "VDEV");

            var PDIPTable = new TableGenerator();
            PDIPTable.setDocument(document);
            PDIPTable.setColumns(["device", "name", "value"]);
            PDIPTable.setKeys(["device", "name"]);
            PDIPTable.setCellColors(cellColors);
            var PDIPhtml = PDIPTable.createTable("PDIPTable", "PDIP");

            var PDOPTable = new TableGenerator();
            PDOPTable.setDocument(document);
            PDOPTable.setColumns(["device", "name", "value"]);
            PDOPTable.setKeys(["device", "name"]);
            PDOPTable.setCellColors(cellColors);
            var PDOPhtml = PDOPTable.createTable("PDOPTable", "PDOP");
            /*            
             PIOTable.fillRow({"device": "a1", "type": "b", "name": "c1", "value": "d"});
             PIOTable.fillRow({"device": "a2", "type": "b", "name": "c1", "value": "d2"});
             PIOTable.fillRow({"device": "a2", "type": "AA", "name": "c1", "value": "d2"});
             PIOTable.fillRow({"device": "a1", "type": "TT", "name": "c1", "value": "d2"});/*
             */
            var VDIPTable = new TableGenerator();
            VDIPTable.setDocument(document);
            VDIPTable.setColumns(["name", "nrHigh", "nrLow"]);
            VDIPTable.setKeys(["name"]);
            VDIPTable.setCellColors(cellColors);
            var VDIPhtml = VDIPTable.createTable("VDIPTable", "VDIP");

            var VDOPTable = new TableGenerator();
            VDOPTable.setDocument(document);
            VDOPTable.setColumns(["name", "value"]);
            VDOPTable.setKeys(["name"]);
            VDOPTable.setCellColors(cellColors);
            var VDOPhtml = VDOPTable.createTable("VDOPTable", "VDOP");

            document.getElementById("VDEVhtml").appendChild(VDEVhtml);
            document.getElementById("PDEVhtml").appendChild(PDEVhtml);
            document.getElementById("VDIPhtml").appendChild(VDIPhtml);
            document.getElementById("PDIPhtml").appendChild(PDIPhtml);
            document.getElementById("VDOPhtml").appendChild(VDOPhtml);
            document.getElementById("PDOPhtml").appendChild(PDOPhtml);




            $(document).ready(function () {

                $.post("getStatus.php",
                        {},
                        function (data, status) {
                            var lines = data.split("\n");
                            for (var i = 0; i < lines.length; i++) {
                                if (lines[i].length > 0) {  // php sends empty string from time to time
                                    // document.getElementById("messageDiv").innerHTML += "status " + lines[i] + "<br>";
                                    try {
                                        var obj = JSON.parse(lines[i]);
                                    } catch (e) {
                                        console.log("getStatus : JSON syntax error");
                                    }
                                    if (obj.object == "PDEV") {
                                        PDEVTable.fillRow(obj);
                                    }
                                    if (obj.object == "VDEV") {
                                        VDEVTable.fillRow(obj);
                                    }
                                    if ((obj.object == "VIO") && (obj.type == "digitalInput")) {
                                        VDIPTable.fillRow(obj);
                                    }
                                    if ((obj.object == "VIO") && (obj.type == "digitalOutput")) {
                                        VDOPTable.fillRow(obj);
                                    }
                                    if ((obj.object == "PIO") && (obj.type == "digitalInput")) {
                                        PDIPTable.fillRow(obj);
                                    }
                                    if ((obj.object == "PIO") && (obj.type == "digitalOutput")) {
                                        PDOPTable.fillRow(obj);
                                    }
                                }
                            }
                        }
                );



                if (typeof (EventSource) !== "undefined") {
                    var updateFeed = new EventSource("updateFeed.php");
                    updateFeed.onmessage = function (event) {
                        if (event.data.length > 0) {  // php sends empty string from time to time
  //                          document.getElementById("messageDiv").innerHTML += "update " + event.data + "<br>";
                            try {
                                var obj = JSON.parse(event.data);
                            } catch (e) {
                                console.log("updateFeed: JSON syntax error");
                            }

                            if (obj.object == "PDEV") {
                                PDEVTable.fillRow(obj);
                            }
                            if (obj.object == "VDEV") {
                                VDEVTable.fillRow(obj);
                            }
                            if ((obj.object == "VIO") && (obj.type == "digitalInput")) {
                                VDIPTable.fillRow(obj);
                            }
                            if ((obj.object == "VIO") && (obj.type == "digitalOutput")) {
                                VDOPTable.fillRow(obj);
                            }
                            if ((obj.object == "PIO") && (obj.type == "digitalInput")) {
                                PDIPTable.fillRow(obj);
                            }
                            if ((obj.object == "PIO") && (obj.type == "digitalOutput")) {
                                PDOPTable.fillRow(obj);
                            }
                        }
                    };
                } else {
                    document.getElementById("messageDiv").innerHTML = "This browser does not support server-sent events...";
                }


                if (typeof (EventSource) !== "undefined") {
                    var messageFeed = new EventSource("messageFeed.php");
                    messageFeed.onmessage = function (event) {
                        if (event.data.length > 0) {  // php sends empty string from time to time
                            document.getElementById("messageDiv").innerHTML += event.data + "<br>";
                        }
                    };
                } else {
                    document.getElementById("messageDiv").innerHTML = "This browser does not support server-sent events...";
                }
            }
            );

        </script>

    </body>
</html>

